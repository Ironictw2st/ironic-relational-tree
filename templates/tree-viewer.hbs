<div class="tree-viewer-header">
  <button class="back-to-list"><i class="fas fa-arrow-left"></i> Back to List</button>
  <h2>{{tree.name}}</h2>
  <div class="header-right">
    {{#if isGM}}
    <button class="show-to-players" title="Show to Players">
      <i class="fas fa-eye"></i>
    </button>
    <button class="add-map-note" title="Add Map Note">
      <i class="fas fa-map-marker-alt"></i>
    </button>
    {{/if}}
    <button class="add-custom-node"><i class="fas fa-user-plus"></i> Add Custom</button>
    <span class="help-text">Drag actors from the sidebar onto the canvas</span>
  </div>
</div>

<div class="tree-canvas" style="min-height: 600px;">
  <svg class="connection-layer" width="100%" height="100%"></svg>
  
  <!-- Legend -->
  <div class="tree-legend">
    <div class="legend-title">Relationships</div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #800000;"></span>
      <span class="legend-label">Rival</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #ff4444;"></span>
      <span class="legend-label">Enemy</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #888888;"></span>
      <span class="legend-label">Neutral</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #44ff44;"></span>
      <span class="legend-label">Friendly</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #00FFFF;"></span>
      <span class="legend-label">Alliance</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #aa44ff;"></span>
      <span class="legend-label">Family</span>
    </div>
    <div class="legend-item">
      <span class="legend-line" style="background-color: #ff69b4;"></span>
      <span class="legend-label">Romantic</span>
    </div>
  </div>
  
  {{#each nodes}}
  <div class="tree-node {{#if this.isCustom}}custom-node{{/if}}" data-node-id="{{this.id}}" style="left: {{this.x}}px; top: {{this.y}}px;">
    <div class="node-controls">
      <button class="remove-node" title="Remove"><i class="fas fa-times"></i></button>
      {{#if this.isCustom}}
      <button class="edit-node" title="Edit"><i class="fas fa-edit"></i></button>
      {{/if}}
      <button class="connect-node" title="Connect"><i class="fas fa-link"></i></button>
      <button class="resize-larger" title="Larger"><i class="fas fa-plus"></i></button>
      <button class="resize-smaller" title="Smaller"><i class="fas fa-minus"></i></button>
    </div>
    <img src="{{this.actorImg}}" alt="{{this.actorName}}" style="width: {{this.size}}px; height: {{this.size}}px;" />
    <span class="actor-name" style="font-size: {{this.fontSize}}px; max-width: {{this.nameMaxWidth}}px;">{{this.actorName}}</span>
    {{#if this.isCustom}}
    <span class="custom-badge" title="Custom Node"><i class="fas fa-star"></i></span>
    {{/if}}
  </div>
  {{/each}}
</div>

<style>
.tree-viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem;
  border-bottom: 1px solid var(--color-border-dark);
  gap: 1rem;
}

.tree-viewer-header h2 {
  margin: 0;
  flex: 1;
  text-align: center;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.show-to-players,
.add-map-note {
  width: 36px;
  height: 36px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-bg-btn);
  border: 1px solid var(--color-border-dark);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.show-to-players:hover {
  background: #44ff44;
  border-color: #44ff44;
  color: black;
}

.add-map-note:hover {
  background: #000000;
  border-color: #000000;
  color: white;
}

.add-custom-node {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.75rem;
  background: #000000;
  border: none;
  border-radius: 4px;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
}

.add-custom-node:hover {
  filter: brightness(1.1);
}

.help-text {
  color: var(--color-text-dark-secondary);
  font-size: 0.9em;
  font-style: italic;
}

.tree-canvas {
  position: relative;
  width: 100%;
  height: 600px;
  background: var(--color-bg-option);
  overflow: auto;
}

.connection-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 5;
  overflow: visible;
}

.connection-line {
  stroke-width: 3;
  pointer-events: all;
  cursor: pointer;
  fill: none;
}

.connection-line:hover {
  stroke-width: 5;
  filter: brightness(1.3);
}

/* Legend */
.tree-legend {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--color-bg-btn);
  border: 1px solid var(--color-border-dark);
  border-radius: 6px;
  padding: 0.5rem;
  z-index: 100;
  min-width: 120px;
}

.tree-legend .legend-title {
  font-weight: bold;
  font-size: 0.9em;
  margin-bottom: 0.5rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid var(--color-border-dark);
}

.tree-legend .legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.2rem 0;
  font-size: 0.85em;
}

.tree-legend .legend-line {
  width: 20px;
  height: 3px;
  border-radius: 2px;
}

.tree-legend .legend-label {
  color: var(--color-text-dark-primary);
}

/* Nodes */
.tree-node {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.5rem;
  background: var(--color-bg-btn);
  border: none;
  border-radius: 8px;
  cursor: move;
  z-index: 10;
  user-select: none;
}

.tree-node.dragging {
  opacity: 0.7;
  z-index: 100;
}

.tree-node.connecting {
  box-shadow: 0 0 10px #000000;
  cursor: pointer;
}

.node-controls {
  position: absolute;
  top: -30px;
  display: flex;
  gap: 0.25rem;
  background: var(--color-bg-btn);
  border: 1px solid var(--color-border-dark);
  border-radius: 4px;
  padding: 0.25rem;
  opacity: 0;
  transition: opacity 0.2s;
}

.tree-node:hover .node-controls {
  opacity: 1;
}

.node-controls button {
  width: 24px;
  height: 24px;
  padding: 0;
  font-size: 0.8em;
  border: none;
  background: var(--color-bg-option);
  border-radius: 3px;
  cursor: pointer;
}

.node-controls button:hover {
  background: var(--color-bg-option-hover);
}

.tree-node img {
  border-radius: 50%;
  border: 2px solid var(--color-border-dark);
  object-fit: cover;
}

.actor-name {
  margin-top: 0.5rem;
  font-weight: bold;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.custom-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 20px;
  height: 20px;
  background: #000000;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.6em;
  border: none;
}

/* Connection Type Picker */
.connection-type-picker {
  background: var(--color-bg-btn);
  border: 1px solid var(--color-border-dark);
  border-radius: 6px;
  padding: 0.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  min-width: 150px;
}

.connection-type-picker .picker-title {
  font-weight: bold;
  margin-bottom: 0.5rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid var(--color-border-dark);
  font-size: 0.9em;
}

.connection-type-picker .picker-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.4rem 0.6rem;
  margin: 0.25rem 0;
  text-align: left;
  background: var(--color-bg-option);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.connection-type-picker .picker-option:hover {
  background: var(--color-bg-option-hover);
}

.connection-type-picker .picker-cancel {
  display: block;
  width: 100%;
  padding: 0.4rem 0.6rem;
  margin-top: 0.5rem;
  text-align: center;
  background: transparent;
  border: 1px solid var(--color-border-dark);
  border-radius: 4px;
  cursor: pointer;
  color: var(--color-text-dark-secondary);
}

/* Connection Edit Menu */
.connection-edit-menu {
  background: var(--color-bg-btn);
  border: 1px solid var(--color-border-dark);
  border-radius: 6px;
  padding: 0.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  min-width: 160px;
}

.connection-edit-menu .menu-title {
  font-weight: bold;
  margin-bottom: 0.5rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid var(--color-border-dark);
  font-size: 0.9em;
}

.connection-edit-menu .menu-section {
  font-size: 0.85em;
  color: var(--color-text-dark-secondary);
  margin: 0.5rem 0 0.25rem 0;
}

.connection-edit-menu .menu-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.4rem 0.6rem;
  margin: 0.25rem 0;
  text-align: left;
  background: var(--color-bg-option);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.connection-edit-menu .menu-option:hover {
  background: var(--color-bg-option-hover);
}

.connection-edit-menu .delete-connection {
  color: #ff4444;
}

.connection-edit-menu hr {
  border: none;
  border-top: 1px solid var(--color-border-dark);
  margin: 0.5rem 0;
}

/* Color indicator for menus */
.color-indicator {
  width: 16px;
  height: 3px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* Open Tree Button in Journal */
.open-tree-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: #000000;
  border: none;
  border-radius: 4px;
  color: white;
  cursor: pointer;
  margin: 1rem 0;
}

.open-tree-btn:hover {
  filter: brightness(1.1);
}
</style>